<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ stock_info.name }} - Enhanced Prediction</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .stock-info h1 {
            color: #2d3748;
            font-size: 2.8rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .stock-meta {
            color: #718096;
            font-size: 1.2rem;
        }
        
        .price-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            min-width: 250px;
            box-shadow: 0 10px 40px rgba(79, 172, 254, 0.3);
        }
        
        .current-price {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .price-change {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        
        .confidence-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            display: inline-block;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .confidence-high { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
        .confidence-medium { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        .confidence-low { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .chart-title {
            color: #2d3748;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-title i {
            font-size: 1.6rem;
            color: #667eea;
        }
        
        .chart-wrapper {
            height: 400px;
            position: relative;
        }
        
        .prediction-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(240, 147, 251, 0.3);
        }
        
        .prediction-price {
            font-size: 3rem;
            font-weight: 800;
            margin: 15px 0;
        }
        
        .expected-change {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .stat-title {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            color: #2d3748;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .technical-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .indicator {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .indicator-label {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .indicator-value {
            color: #2d3748;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .indicator-bullish { color: #10b981; }
        .indicator-bearish { color: #ef4444; }
        .indicator-neutral { color: #f59e0b; }
        
        .model-info {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .back-button {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
        }
        
        .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }
        
        .confidence-meter {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .confidence-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
        }
        
        .confidence-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #718096;
        }
        
        .timeframe-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .timeframe-btn {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .timeframe-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            color: #718096;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stock-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .price-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <div class="stock-header">
                <div class="stock-info">
                    <h1>{{ stock_info.name }}</h1>
                    <div class="stock-meta">
                        {{ stock_info.company }} ‚Ä¢ {{ stock_info.sector }}
                    </div>
                </div>
                
                <div class="price-card">
                    <div class="current-price">‚Çπ{{ current_price|round(2) }}</div>
                    <div class="price-change {% if predicted_price >= current_price %}positive{% else %}negative{% endif %}">
                        {{ "‚ñ≤" if predicted_price >= current_price else "‚ñº" }} 
                        ‚Çπ{{ (predicted_price - current_price)|round(2) }} 
                        ({{ ((predicted_price - current_price) / current_price * 100)|round(2) }}%)
                    </div>
                    <div class="confidence-badge {% if confidence >= 80 %}confidence-high{% elif confidence >= 60 %}confidence-medium{% else %}confidence-low{% endif %}">
                        Model Confidence: {{ confidence|round(1) }}%
                    </div>
                </div>
            </div>
            
            <!-- Confidence Meter -->
            <div class="confidence-meter">
                <div class="confidence-fill" 
                     style="width: {{ confidence }}%;
                            {% if confidence >= 80 %}background: linear-gradient(90deg, #10b981, #34d399);
                            {% elif confidence >= 60 %}background: linear-gradient(90deg, #f59e0b, #fbbf24);
                            {% else %}background: linear-gradient(90deg, #ef4444, #f87171);{% endif %}">
                </div>
            </div>
            <div class="confidence-labels">
                <span>Low (40%)</span>
                <span>Medium (60%)</span>
                <span>High (80%)</span>
                <span>Excellent (95%)</span>
            </div>
        </div>
        
        <!-- Main Charts Grid -->
        <div class="charts-grid">
            <!-- Candlestick Chart with SMA -->
            <div class="chart-container">
                <div class="chart-title">
                    üìä Candlestick Chart with Moving Averages
                </div>
                <div class="timeframe-selector">
                    <button class="timeframe-btn active" onclick="changeTimeframe('1M')">1M</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('3M')">3M</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('6M')">6M</button>
                    <button class="timeframe-btn" onclick="changeTimeframe('1Y')">1Y</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="candlestickChart"></canvas>
                </div>
            </div>
            
            <!-- Technical Indicators Radar Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    üìà Technical Analysis Radar
                </div>
                <div class="chart-wrapper">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
            
            <!-- Price Prediction Probability Distribution -->
            <div class="chart-container">
                <div class="chart-title">
                    üìä Price Probability Distribution
                </div>
                <div class="chart-wrapper">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
            
            <!-- Market Sentiment & Risk Analysis -->
            <div class="chart-container">
                <div class="chart-title">
                    üéØ Market Sentiment & Risk Analysis
                </div>
                <div class="chart-wrapper">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Technical Indicators -->
        <div class="chart-container">
            <div class="chart-title">
                üî¨ Technical Indicators
            </div>
            <div class="technical-indicators">
                <div class="indicator">
                    <div class="indicator-label">RSI (14)</div>
                    <div class="indicator-value {% if technical_indicators.rsi < 30 %}indicator-bullish{% elif technical_indicators.rsi > 70 %}indicator-bearish{% else %}indicator-neutral{% endif %}">
                        {{ technical_indicators.rsi|round(2) if technical_indicators.rsi else 'N/A' }}
                    </div>
                    <small>{% if technical_indicators.rsi < 30 %}Oversold{% elif technical_indicators.rsi > 70 %}Overbought{% else %}Neutral{% endif %}</small>
                </div>
                
                <div class="indicator">
                    <div class="indicator-label">MACD</div>
                    <div class="indicator-value {% if technical_indicators.macd and technical_indicators.macd_signal and technical_indicators.macd > technical_indicators.macd_signal %}indicator-bullish{% else %}indicator-bearish{% endif %}">
                        {{ technical_indicators.macd|round(4) if technical_indicators.macd else 'N/A' }}
                    </div>
                    <small>{% if technical_indicators.macd and technical_indicators.macd_signal and technical_indicators.macd > technical_indicators.macd_signal %}Bullish{% else %}Bearish{% endif %} Signal</small>
                </div>
                
                <div class="indicator">
                    <div class="indicator-label">Volatility</div>
                    <div class="indicator-value {% if technical_indicators.volatility and technical_indicators.volatility < 0.3 %}indicator-bullish{% elif technical_indicators.volatility and technical_indicators.volatility > 0.5 %}indicator-bearish{% else %}indicator-neutral{% endif %}">
                        {{ (technical_indicators.volatility * 100)|round(2) if technical_indicators.volatility else 'N/A' }}%
                    </div>
                    <small>Annualized</small>
                </div>
                
                <div class="indicator">
                    <div class="indicator-label">Support Level</div>
                    <div class="indicator-value">
                        ‚Çπ{{ (current_price * 0.95)|round(2) }}
                    </div>
                    <small>5% below current</small>
                </div>
                
                <div class="indicator">
                    <div class="indicator-label">Resistance Level</div>
                    <div class="indicator-value">
                        ‚Çπ{{ (current_price * 1.05)|round(2) }}
                    </div>
                    <small>5% above current</small>
                </div>
                
                <div class="indicator">
                    <div class="indicator-label">Trend Strength</div>
                    <div class="indicator-value {% if technical_indicators.sma_10 and technical_indicators.sma_20 and technical_indicators.sma_10 > technical_indicators.sma_20 %}indicator-bullish{% else %}indicator-bearish{% endif %}">
                        {{ 'Strong' if model_agreement > 0.7 else 'Weak' }}
                    </div>
                    <small>{{ 'Uptrend' if technical_indicators.sma_10 and technical_indicators.sma_20 and technical_indicators.sma_10 > technical_indicators.sma_20 else 'Downtrend' }}</small>
                </div>
            </div>
        </div>
        
        <!-- Model Information -->
        <div class="model-info">
            <div class="chart-title">
                ü§ñ Prediction Model Details
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Models Used</div>
                    <div class="stat-value">{{ available_models|length }}</div>
                    <small>{{ available_models|join(', ') }}</small>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Model Agreement</div>
                    <div class="stat-value">{{ (model_agreement * 100)|round(1) }}%</div>
                    <small>{{ 'High Consensus' if model_agreement > 0.7 else 'Medium Consensus' if model_agreement > 0.5 else 'Low Consensus' }}</small>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Data Points</div>
                    <div class="stat-value">{{ stock_info.data_points }}</div>
                    <small>Historical records analyzed</small>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Risk Level</div>
                    <div class="stat-value {% if confidence >= 80 %}indicator-bullish{% elif confidence >= 60 %}indicator-neutral{% else %}indicator-bearish{% endif %}">
                        {{ 'Low' if confidence >= 80 else 'Medium' if confidence >= 60 else 'High' }}
                    </div>
                    <small>Based on volatility & confidence</small>
                </div>
            </div>
        </div>
        
        <button class="back-button" onclick="window.history.back()">
            ‚Üê Back to Dashboard
        </button>
    </div>
    
    <script>
        // In enhanced_prediction.html, at the beginning of the <script> section
        document.addEventListener('DOMContentLoaded', function() {
            // Register financial charts
            if (typeof Chart !== 'undefined' && Chart.Financial) {
                Chart.register(Chart.Financial);
            }
            if (typeof ChartAnnotation !== 'undefined') {
                Chart.register(ChartAnnotation);
            }
            
            console.log('Enhanced prediction page loaded');
            initializeEnhancedCharts();
        });
        // Convert Python data to JavaScript
        const stockData = {
            name: "{{ stock_info.name }}",
            currentPrice: {{ current_price }},
            predictedPrice: {{ predicted_price }},
            confidence: {{ confidence }},
            modelAgreement: {{ model_agreement }},
            historicalData: {{ historical_data|tojson|safe }},
            technicalIndicators: {{ technical_indicators|tojson|safe }},
            availableModels: {{ available_models|tojson|safe }}
        };
        
        // Initialize all charts
        document.addEventListener('DOMContentLoaded', function() {
            renderCandlestickChart();
            renderRadarChart();
            renderDistributionChart();
            renderSentimentChart();
            updateConfidenceMeter();
        });
        
        function renderCandlestickChart() {
            const ctx = document.getElementById('candlestickChart').getContext('2d');
            
            // Prepare candlestick data
            const candlestickData = stockData.historicalData.ohlc.slice(-60).map(item => ({
                x: new Date(item.date).getTime(),
                o: item.open,
                h: item.high,
                l: item.low,
                c: item.close
            }));
            
            // Calculate SMAs
            const closePrices = candlestickData.map(item => item.c);
            const sma10 = calculateSMA(closePrices, 10);
            const sma20 = calculateSMA(closePrices, 20);
            const sma50 = calculateSMA(closePrices, 50);
            
            new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: stockData.name,
                        data: candlestickData,
                        color: {
                            up: '#10b981',
                            down: '#ef4444',
                            unchanged: '#94a3b8'
                        },
                        borderColor: {
                            up: '#10b981',
                            down: '#ef4444',
                            unchanged: '#94a3b8'
                        }
                    }, {
                        label: 'SMA 10',
                        data: candlestickData.map((item, index) => ({
                            x: item.x,
                            y: sma10[index] || null
                        })),
                        borderColor: '#3b82f6',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        type: 'line'
                    }, {
                        label: 'SMA 20',
                        data: candlestickData.map((item, index) => ({
                            x: item.x,
                            y: sma20[index] || null
                        })),
                        borderColor: '#f59e0b',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        type: 'line'
                    }, {
                        label: 'SMA 50',
                        data: candlestickData.map((item, index) => ({
                            x: item.x,
                            y: sma50[index] || null
                        })),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        type: 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#4b5563',
                                font: {
                                    size: 12,
                                    family: "'Segoe UI', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937',
                            bodyColor: '#4b5563',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '‚Çπ' + context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM yy'
                                }
                            },
                            grid: {
                                color: 'rgba(229, 231, 235, 0.5)'
                            },
                            ticks: {
                                color: '#6b7280'
                            }
                        },
                        y: {
                            position: 'right',
                            grid: {
                                color: 'rgba(229, 231, 235, 0.5)'
                            },
                            ticks: {
                                color: '#6b7280',
                                callback: function(value) {
                                    return '‚Çπ' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderRadarChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            const indicators = stockData.technicalIndicators;
            const data = {
                labels: ['Trend Strength', 'Momentum', 'Volatility', 'Volume', 'Support', 'Risk'],
                datasets: [{
                    label: 'Current Status',
                    data: [
                        Math.min(100, (indicators.sma_10 && indicators.sma_20) ? 
                            ((indicators.sma_10 - indicators.sma_20) / indicators.sma_20 * 1000 + 50) : 50),
                        indicators.rsi ? Math.min(100, Math.abs(50 - indicators.rsi) * 2) : 50,
                        indicators.volatility ? Math.max(0, 100 - (indicators.volatility * 200)) : 50,
                        70, // Volume score (would need volume data)
                        80, // Support level score
                        Math.max(0, 100 - (stockData.confidence * 0.7)) // Risk score (inverse of confidence)
                    ],
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgb(102, 126, 234)',
                    pointBackgroundColor: 'rgb(102, 126, 234)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(102, 126, 234)'
                }, {
                    label: 'Optimal Range',
                    data: [80, 60, 70, 75, 85, 30],
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderColor: 'rgba(16, 185, 129, 0.5)',
                    pointRadius: 0,
                    borderDash: [5, 5]
                }]
            };
            
            new Chart(ctx, {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(229, 231, 235, 0.5)'
                            },
                            grid: {
                                color: 'rgba(229, 231, 235, 0.5)'
                            },
                            pointLabels: {
                                color: '#4b5563',
                                font: {
                                    size: 11,
                                    family: "'Segoe UI', sans-serif"
                                }
                            },
                            ticks: {
                                backdropColor: 'transparent',
                                color: '#9ca3af',
                                font: {
                                    size: 10
                                }
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#4b5563',
                                font: {
                                    size: 12,
                                    family: "'Segoe UI', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)}/100`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            // Generate probability distribution based on confidence and volatility
            const currentPrice = stockData.currentPrice;
            const volatility = stockData.technicalIndicators.volatility || 0.3;
            const confidence = stockData.confidence / 100;
            
            // Create normal distribution around predicted price
            const dataPoints = 50;
            const minPrice = currentPrice * (1 - volatility);
            const maxPrice = currentPrice * (1 + volatility);
            const step = (maxPrice - minPrice) / dataPoints;
            
            const prices = [];
            const probabilities = [];
            
            for (let i = 0; i < dataPoints; i++) {
                const price = minPrice + (i * step);
                const z = (price - currentPrice) / (currentPrice * volatility);
                const probability = Math.exp(-0.5 * z * z) / (volatility * currentPrice * Math.sqrt(2 * Math.PI));
                
                prices.push(price);
                probabilities.push(probability * 100); // Convert to percentage
            }
            
            // Find prediction zone (68% confidence interval)
            const meanIndex = Math.floor(dataPoints / 2);
            const stdDev = volatility * currentPrice;
            const lowerBound = currentPrice - stdDev;
            const upperBound = currentPrice + stdDev;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: prices.map(p => p.toFixed(2)),
                    datasets: [{
                        label: 'Price Probability Distribution',
                        data: probabilities,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }, {
                        label: 'Prediction Zone (68% Confidence)',
                        data: probabilities.map((prob, i) => {
                            const price = prices[i];
                            return (price >= lowerBound && price <= upperBound) ? prob : null;
                        }),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        pointRadius: 0,
                        borderWidth: 2
                    }, {
                        type: 'scatter',
                        label: 'Current Price',
                        data: [{
                            x: currentPrice,
                            y: probabilities[meanIndex]
                        }],
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 2,
                        pointRadius: 6
                    }, {
                        type: 'scatter',
                        label: 'Predicted Price',
                        data: [{
                            x: stockData.predictedPrice,
                            y: probabilities[meanIndex] * 0.8
                        }],
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#4b5563',
                                font: {
                                    size: 12,
                                    family: "'Segoe UI', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.type === 'scatter') {
                                        return `${context.dataset.label}: ‚Çπ${context.parsed.x.toFixed(2)}`;
                                    }
                                    return `Probability: ${context.parsed.y.toFixed(2)}% at ‚Çπ${prices[context.dataIndex].toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Price (‚Çπ)',
                                color: '#6b7280'
                            },
                            grid: {
                                color: 'rgba(229, 231, 235, 0.5)'
                            },
                            ticks: {
                                color: '#6b7280',
                                callback: function(value) {
                                    return '‚Çπ' + value;
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability Density (%)',
                                color: '#6b7280'
                            },
                            grid: {
                                color: 'rgba(229, 231, 235, 0.5)'
                            },
                            ticks: {
                                color: '#6b7280',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderSentimentChart() {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            
            // Sentiment analysis data
            const sentimentData = {
                bullish: stockData.confidence >= 70 ? 65 : 45,
                bearish: stockData.confidence < 60 ? 40 : 25,
                neutral: 100 - (stockData.confidence >= 70 ? 65 : 45) - (stockData.confidence < 60 ? 40 : 25)
            };
            
            // Risk metrics
            const riskMetrics = {
                volatility: Math.min(100, (stockData.technicalIndicators.volatility || 0.3) * 200),
                drawdown: 25,
                correlation: 40,
                liquidity: 75
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Bullish', 'Bearish', 'Neutral'],
                    datasets: [{
                        label: 'Market Sentiment',
                        data: [sentimentData.bullish, sentimentData.bearish, sentimentData.neutral],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#4b5563',
                                font: {
                                    size: 12,
                                    family: "'Segoe UI', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.x}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(229, 231, 235, 0.5)'
                            },
                            ticks: {
                                color: '#6b7280',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Sentiment Percentage',
                                color: '#6b7280'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(229, 231, 235, 0.5)'
                            },
                            ticks: {
                                color: '#6b7280'
                            }
                        }
                    }
                }
            });
        }
        
        function calculateSMA(data, period) {
            const sma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    sma.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    sma.push(sum / period);
                }
            }
            return sma;
        }
        
        function updateConfidenceMeter() {
            const confidenceFill = document.querySelector('.confidence-fill');
            confidenceFill.style.width = stockData.confidence + '%';
        }
        
        function changeTimeframe(timeframe) {
            // Update active button
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Here you would typically fetch new data based on timeframe
            // For now, we'll just update the chart with filtered data
            console.log('Changing timeframe to:', timeframe);
        }

        // Enhanced chart initialization
        function initializeEnhancedCharts() {
            console.log('Initializing enhanced charts...');
            
            // Check if chart data is available
            const hasChartData = {{ has_technical_data|tojson|safe }};
            const chartData = {{ chart_data|tojson|safe }};
            
            if (!hasChartData || !chartData) {
                console.warn('No chart data available');
                showFallbackCharts();
                return;
            }
            
            try {
                // 1. Initialize Candlestick Chart with SMA
                initCandlestickChart(chartData.candlestick);
                
                // 2. Initialize Technical Radar Chart
                initRadarChart(chartData.technical);
                
                // 3. Initialize Price Distribution Chart
                initDistributionChart();
                
                // 4. Initialize Market Sentiment Chart
                initSentimentChart();
                
                console.log('All enhanced charts initialized');
            } catch (error) {
                console.error('Error initializing charts:', error);
                showFallbackCharts();
            }
        }

        function initCandlestickChart(candlestickData) {
            const ctx = document.getElementById('candlestickChart');
            if (!ctx || !candlestickData || candlestickData.length === 0) {
                console.warn('No candlestick data available');
                return;
            }
            
            // Filter to last 60 days
            const filteredData = candlestickData.slice(-60);
            
            const datasets = [{
                label: 'Price',
                data: filteredData.map(item => ({
                    x: new Date(item.date),
                    o: item.open,
                    h: item.high,
                    l: item.low,
                    c: item.close
                })),
                type: 'candlestick'
            }];
            
            // Add SMA lines if available
            if (filteredData[0].sma_10 !== null) {
                datasets.push({
                    label: 'SMA 10',
                    data: filteredData.map(item => ({
                        x: new Date(item.date),
                        y: item.sma_10
                    })),
                    type: 'line',
                    borderColor: '#3b82f6',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0
                });
            }
            
            if (filteredData[0].sma_20 !== null) {
                datasets.push({
                    label: 'SMA 20',
                    data: filteredData.map(item => ({
                        x: new Date(item.date),
                        y: item.sma_20
                    })),
                    type: 'line',
                    borderColor: '#10b981',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0
                });
            }
            
            if (filteredData[0].sma_50 !== null) {
                datasets.push({
                    label: 'SMA 50',
                    data: filteredData.map(item => ({
                        x: new Date(item.date),
                        y: item.sma_50
                    })),
                    type: 'line',
                    borderColor: '#8b5cf6',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0
                });
            }
            
            new Chart(ctx, {
                type: 'candlestick',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.type === 'candlestick') {
                                        const point = context.raw;
                                        return [
                                            `Open: ‚Çπ${point.o.toFixed(2)}`,
                                            `High: ‚Çπ${point.h.toFixed(2)}`,
                                            `Low: ‚Çπ${point.l.toFixed(2)}`,
                                            `Close: ‚Çπ${point.c.toFixed(2)}`
                                        ];
                                    }
                                    return `${context.dataset.label}: ‚Çπ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { type: 'time', time: { unit: 'month' } },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function initRadarChart(technicalData) {
            const ctx = document.getElementById('radarChart');
            if (!ctx || !technicalData || technicalData.length === 0) {
                console.warn('No technical data for radar chart');
                return;
            }
            
            const lastData = technicalData[technicalData.length - 1];
            
            // Calculate radar values from technical indicators
            const rsiScore = lastData.rsi ? calculateRSIScore(lastData.rsi) : 50;
            const macdScore = lastData.macd ? calculateMACDScore(lastData.macd, lastData.signal) : 50;
            
            const radarData = {
                labels: ['Trend Strength', 'Momentum', 'Volatility', 'Volume', 'Support', 'Risk'],
                datasets: [{
                    label: 'Technical Score',
                    data: [
                        calculateTrendScore(technicalData),
                        rsiScore,
                        calculateVolatilityScore(technicalData),
                        70, // Placeholder for volume
                        80, // Placeholder for support
                        calculateRiskScore(technicalData)
                    ],
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgb(102, 126, 234)',
                    pointBackgroundColor: 'rgb(102, 126, 234)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(102, 126, 234)'
                }]
            };
            
            new Chart(ctx, {
                type: 'radar',
                data: radarData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            ticks: { display: false }
                        }
                    }
                }
            });
        }

        function initDistributionChart() {
            const ctx = document.getElementById('distributionChart');
            if (!ctx) return;
            
            const currentPrice = {{ current_price|tojson|safe }};
            const predictedPrice = {{ predicted_price|tojson|safe }};
            const volatility = {{ technical_indicators.volatility|default(0.3)|tojson|safe }};
            
            // Generate normal distribution
            const data = generateNormalDistribution(currentPrice, predictedPrice, volatility);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Probability Density',
                        data: data.values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        annotation: {
                            annotations: {
                                currentPrice: {
                                    type: 'line',
                                    xMin: currentPrice,
                                    xMax: currentPrice,
                                    borderColor: '#10b981',
                                    borderWidth: 2,
                                    label: {
                                        content: 'Current Price',
                                        enabled: true,
                                        position: 'end'
                                    }
                                },
                                predictedPrice: {
                                    type: 'line',
                                    xMin: predictedPrice,
                                    xMax: predictedPrice,
                                    borderColor: '#f59e0b',
                                    borderWidth: 2,
                                    label: {
                                        content: 'Predicted',
                                        enabled: true,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        function initSentimentChart() {
            const ctx = document.getElementById('sentimentChart');
            if (!ctx) return;
            
            const confidence = {{ confidence|tojson|safe }};
            
            // Calculate sentiment percentages based on confidence
            const bullish = confidence >= 70 ? 65 : 45;
            const bearish = confidence < 60 ? 40 : 25;
            const neutral = 100 - bullish - bearish;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Bullish', 'Bearish', 'Neutral'],
                    datasets: [{
                        data: [bullish, bearish, neutral],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        // Helper functions
        function calculateRSIScore(rsi) {
            if (rsi < 30) return 20;  // Oversold
            if (rsi > 70) return 80;  // Overbought
            if (rsi >= 40 && rsi <= 60) return 60; // Neutral range
            return 50;
        }

        function calculateMACDScore(macd, signal) {
            return macd > signal ? 70 : 30;
        }

        function calculateTrendScore(data) {
            if (!data || data.length < 2) return 50;
            const recent = data.slice(-10);
            const prices = recent.map(d => d.close || 0);
            const trend = prices[prices.length - 1] - prices[0];
            return Math.min(100, 50 + (trend / prices[0] * 100));
        }

        function calculateVolatilityScore(data) {
            if (!data || data.length < 20) return 50;
            const returns = [];
            for (let i = 1; i < data.length; i++) {
                if (data[i].close && data[i-1].close) {
                    returns.push((data[i].close - data[i-1].close) / data[i-1].close);
                }
            }
            const volatility = returns.length > 0 ? 
                Math.sqrt(returns.reduce((a, b) => a + b * b, 0) / returns.length) * Math.sqrt(252) : 0.3;
            return Math.max(0, 100 - (volatility * 200));
        }

        function calculateRiskScore(data) {
            const volatilityScore = calculateVolatilityScore(data);
            const confidence = {{ confidence|tojson|safe }};
            return Math.max(0, 100 - (volatilityScore * 0.6 + confidence * 0.4));
        }

        function generateNormalDistribution(mean, predicted, volatility) {
            const points = 50;
            const stdDev = volatility * mean;
            const min = mean - (3 * stdDev);
            const max = mean + (3 * stdDev);
            const step = (max - min) / points;
            
            const labels = [];
            const values = [];
            
            for (let i = 0; i <= points; i++) {
                const x = min + (i * step);
                labels.push(x.toFixed(2));
                const z = (x - mean) / stdDev;
                values.push(Math.exp(-0.5 * z * z) / (stdDev * Math.sqrt(2 * Math.PI)));
            }
            
            return { labels, values };
        }

        function showFallbackCharts() {
            // Show message if charts couldn't be loaded
            const chartContainers = document.querySelectorAll('.chart-wrapper');
            chartContainers.forEach(container => {
                if (!container.querySelector('canvas')) {
                    container.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #718096;">
                            <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Chart data not available</p>
                        </div>
                    `;
                }
            });
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced prediction page loaded');
            initializeEnhancedCharts();
        });
    </script>
</body>
</html>